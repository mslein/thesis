---
title: "Meta-analysis Manuscript Wrangling"
author: "Maggie Slein"
date: "6/14/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, results = 'hide', message=FALSE}
## loading libraries 
pacman::p_load(metafor, tidyverse, viridis, visreg, forcats, devtools, patchwork, R.rsp)
#devtools::install_github("itchyshin/orchard_plot", subdir = "orchaRd", method= 'libcurl', force = TRUE, build_vignettes = TRUE)
library(orchaRd)
#load data
dat_acclim_0<- read_csv("acclimation_dummytherm_30jun.csv")
dat_full_var_0 <- read_csv("metafor.csv")
```

```{r, echo= FALSE, results = 'hide', message=FALSE}
##wrangling calculations for acclimation data
#make standardized SD columns based on N and SE vs SD
dat_acclim <-dat_acclim_0 %>% 
  mutate ( SD_constant= if_else ( variance_type== 0, constant_variance * sqrt(constant_samp), constant_variance))  %>%
  mutate ( SD_variable= if_else ( variance_type== 0, flux_variance * sqrt(flux_variance) , flux_variance)) 
         
#calculate ES for data
dat_acclim_ES <-escalc(measure="SMD", m1i=constant_resp, m2i=flux_resp, 
            sd1i=`SD_constant`, sd2i= `SD_variable`, n1i=constant_samp, n2i=flux_samp, 
            data=dat_acclim, slab=paste(study_id, experiment_id, response_id, sep=", ")) 

# Note in the above, you loose ~15% of data because of missing sample sizes and SEs reported, below these are removed for now
dat_acclim_ES<-dat_acclim_ES %>% 
  filter (!is.na(yi)) 
```


```{r, echo= FALSE, results = 'hide', message=FALSE}
##wrangling calculations for full variability data
#make standardized SD columns based on N and SE vs SD
dat_full_var <-dat_full_var_0 %>% 
  mutate ( SD_constant= if_else ( variance_type== 0, constant_variance * sqrt(constant_samp), constant_variance))  %>%
  mutate ( SD_variable= if_else ( variance_type== 0, flux_variance * sqrt(flux_variance) , flux_variance)) 
         
#calculate ES for data
dat_full_var_ES <-escalc(measure="SMD", m1i=constant_resp, m2i=flux_resp, 
            sd1i=`SD_constant`, sd2i= `SD_variable`, n1i=constant_samp, n2i=flux_samp, 
            data=dat_full_var, slab=paste(study_id, experiment_id, response_id, sep=", ")) 

# Note in the above, you loose ~15% of data because of missing sample sizes and SEs reported, below these are removed for now
dat_full_var_ES<-dat_full_var_ES %>% 
  filter (!is.na(yi)) 
```
# Motivation and Hypotheses

Variability has been identified as important to organismal success and ecosystem dynamics (Vasseur et al 2014). To further understand the impacts of variability of performance, we conducted to analyses on data that explicitly accounted for acclimation (Acclimation model) and studies focuses solely on non-linear averaging (Non-linear averaging model). 

H-Acclimation: If reared in fluctuating environments, when exposed to different thermal environments, organisms with larger fluctuation ranges will perform worse than those reared in constant environments. Additional covariates, such as age, size, and expsoure temperature will be correlated negative responses.

H-Non-linear averaging: Organisms will perform better in constant environments than fluctuating environments. Additional covariates, such as age, size, and large fluctuation range will be correlated negative responses.

```{r pressure, echo=FALSE, fig.cap="Conceptual figure demonstrating how acclimation and non-linear averaging account for different aspects of performance.", out.width = '100%'}
knitr::include_graphics("conceptfig_30jun.png")
```

\clearpage



# Acclimation Model 

This data and analysis accounts for the temperatures at which organisms are reared and how their performance compares when exposed to different temperature. The results from this model has very similar results from the model I originally ran for my thesis...

## Acclimation with temperature modifiers
```{r, echo=FALSE}
temp_acclimation_model <- rma.mv(yi, vi, data=dat_acclim_ES, mods=~flux_range * mean_temp_reared,
               random = ~1 | study_id / experiment_id/ response_id,
                 method="REML") 
temp_acclimation_model
```

## Acclimation with trait modifiers
```{r, echo=FALSE}
trait_acclimation_model<-rma.mv(yi, vi, data=dat_acclim_ES, 
                                mods = ~exp_age + size + org_level + exposure_temp, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML") 
trait_acclimation_model
```

## Acclimation with all modifiers
```{r, echo=FALSE}
acclimation_model<-rma.mv(yi, vi, data=dat_acclim_ES, 
            mods = ~flux_range * mean_temp_reared + exp_age + size + org_level + exposure_temp, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML") 
acclimation_model
```


# Effects of non-linear averaging
This uses the full dataset from my thesis (with more data from the additional search). Interesting that this time, mean temp is the only significant predictor?

## Non-linear averaging model with temperature modifiers
```{r, echo= FALSE}
temp_full_var_model <- rma.mv(yi, vi, data=dat_full_var_ES, 
                                mods = ~flux_range * mean_temp_constant,
               random = ~1 | study_id / experiment_id/ response_id,
                 method="REML") 
temp_full_var_model
```

## Non-linear averaging model with trait modifiers
```{r, echo = FALSE}
trait_full_var_model <-rma.mv(yi, vi, data=dat_full_var_ES, mods = ~exp_age + size + org_level, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML") 
trait_full_var_model
```

## Non-linear averaging model with all modifiers
```{r, echo = FALSE}
full_var_model <-rma.mv(yi, vi, data=dat_full_var_ES, 
                        mods = ~flux_range * mean_temp_constant + exp_age + size + org_level, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML") 
full_var_model


pacman::p_load(esc, dmetar)
summary(full_var_model)
convert_z2r(1.3702) #r=0.8787378
var.comp(full_var_model)

summary(acclimation_model)
convert_z2r(6.0093) #r=0.9999879
```

```{r}
#Model selection 
AIC(temp_acclimation_model, trait_acclimation_model, acclimation_model, temp_full_var_model, trait_full_var_model, full_var_model)
```

# Figures

```{r, echo=FALSE}
normalized_acclim <- dat_acclim_ES %>% filter(between(yi, -5, 5))
normalized_var <- dat_full_var_ES  %>% filter(between(yi, -5, 5))

dummy_acclim <- rma.mv(yi, vi, data=normalized_acclim, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML")
dummy_var <- rma.mv(yi, vi, data=normalized_var, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML")

I2_acclim <- i2_ml(dummy_var)
I2_var <-i2_ml(dummy_acclim)

p1 <- orchard_plot(dummy_acclim, mod = "Int", xlab = "Standardised mean difference", transfm = "none", )+
  annotate(geom = "text", x = 0, y = 1.5, label = "Acclimation")+
  annotate(geom = "text", x = -4.7, y = 1.5, label = paste0("italic(I)^{2} == ",
round(I2_acclim[1] * 100, 2)), color = "black", parse = TRUE, size = 5) + annotate(geom = "text",
x = -3.7, y = 1.49, label = "%", color = "black", parse = FALSE, size = 5)

p2 <- orchard_plot(dummy_var, mod = "Int", xlab = "Standardised mean difference", transfm = "none")+
  annotate(geom = "text", x = 0, y = 1.5, label = "Non-linear averaging and acclimation")+
  annotate(geom = "text", x = -4.1, y = 1.5, label = paste0("italic(I)^{2} == ",
round(I2_var[1] * 100, 2)), color = "black", parse = TRUE, size = 5) + annotate(geom = "text",
x = -3.1, y = 1.49, label = "%", color = "black", parse = FALSE, size = 5)
p1 / p2
```


```{r, echo=FALSE}
mean_temp_acclim <- normalized_acclim %>%
  group_by(mean_temp_reared, flux_range) %>%
  summarise(yi=mean(yi), 
            vi=mean(vi))

mean_var<-normalized_var %>%
  group_by(mean_temp_constant, flux_range) %>%
  summarise(yi=mean(yi), 
            vi=mean(vi))
```

```{r, echo=FALSE}
ggplot(normalized_acclim, aes(y=yi, x=mean_temp_reared, fill=flux_range))+
  geom_line(y=0, linetype = "dashed")+
  geom_jitter(alpha = 0.5, pch=21,size=1, width = 0.7, height = 0.7)+
  geom_errorbar(data=mean_temp_acclim, aes(ymin=yi-vi, ymax=yi+vi), size=.7, width=.4, color = "black")+
  geom_point(data = mean_temp_acclim, size=4, pch=21, colour="black")+
  theme_bw()+
  scale_fill_viridis()+
  ggtitle("Acclimation and fluctuation range")
 
ggplot(normalized_var, aes(y=yi, x=mean_temp_constant, fill=flux_range))+
  geom_jitter(alpha = 0.5, pch=21,size=1)+
  geom_line(y=0, linetype = "dashed")+
  geom_errorbar(data=mean_var, aes(ymin=yi-vi, ymax=yi+vi), size=.7, width=.4, color = "black")+
  geom_jitter(data = mean_var, size=4, pch=21, colour="black")+
  theme_bw()+
  scale_fill_viridis()+
  ggtitle("Non-linear averaging + acclimation and fluctuation range")
  

ggplot(normalized_var, aes(y=yi, x=mean_temp_constant, fill=mean_temp_constant))+
  geom_jitter(alpha = 0.5, pch=21,size=1)+
  geom_line(y=0, linetype = "dashed")+
  geom_errorbar(data=mean_var, aes(ymin=yi-vi, ymax=yi+vi), size=.7, width=.4, color = "black")+
  geom_jitter(data = mean_var, size=4, pch=21, colour="black")+
  theme_bw()+
  scale_fill_viridis()+
  ggtitle("Non-linear averaging + acclimation and mean temperature")
  

```







```{r, echo=FALSE}
forest_acclim<- dat_acclim_ES %>%
  group_by(mean_temp_reared, flux_range) %>%
  summarise(mean_yi = mean(yi),
            mean_vi = mean(vi)) %>%
  unite(group, c(mean_temp_reared, flux_range), sep = " range ", remove = FALSE)%>%
  arrange(desc(flux_range))

forest_var<- normalized_var %>%
  group_by(mean_temp_constant, flux_range) %>%
  summarise(mean_yi = mean(yi),
            mean_vi = mean(vi)) %>%
  unite(group, c(mean_temp_constant, flux_range), sep = "+/-", remove = FALSE) %>%
  arrange(desc(flux_range))

forest(forest_acclim$mean_yi, forest_acclim$mean_vi, slab=forest_acclim$group, pch =19, psize=1, col = "gray2", 
       header=TRUE, cex=0.77)

forest(forest_var$mean_yi, forest_var$mean_vi, slab=forest_var$group, pch =19, psize=1, col = "gray2", 
       header=TRUE, cex=0.77)

```


## Funnel plot of acclimation data 
````{r, echo=FALSE}
funnel(dummy_acclim, level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), refline=0, legend=TRUE)
```
## Funnel plot of non-linear averaging + acclimation data 
````{r, echo=FALSE}
funnel(dummy_var, level=c(90, 95, 99), shade=c("white", "gray55", "gray75"), refline=0, legend=TRUE)
```

```{r, echo=FALSE}
p3<-normalized_acclim %>%
  ggplot(aes(x=flux_range, y=yi, color=as.factor(mean_temp_reared)))+
  scale_color_viridis(discrete=TRUE)+
  geom_point(size=3, alpha =0.5)+
  geom_smooth(method="lm")+
  theme_bw()

p4<-normalized_var %>%
  ggplot(aes(x=flux_range, y=yi, color=as.factor(mean_temp_constant)))+
  scale_color_viridis(discrete=TRUE)+
  geom_point(size= 3, alpha =0.5)+
  geom_smooth(method="lm")+
  theme_bw()
p3/p4

normalized_acclim %>%
  ggplot(aes(x=as.factor(flux_range), y=yi, color=as.factor(mean_temp_reared)))+
  scale_color_viridis(discrete = TRUE)+
  geom_boxplot()+
  geom_point(alpha=0.5)+
  theme_bw()

normalized_var %>%
  ggplot(aes(x=as.factor(flux_range), y=yi, color=as.factor(mean_temp_constant)))+
  scale_color_viridis(discrete = TRUE)+
  geom_boxplot()+
  geom_point(alpha=0.5)+
  theme_bw()

```






# Supplementary code and models 

## Acclimation data split out by CT data and other thermal performance metrics 
```{r, echo=FALSE, message=FALSE, results='hide'}
CT_acclim_data <- dat_acclim_ES %>%
  filter(resp_def %in% c("CTmax", "CT max", "CTmin", "LTmax", "LTmin", "Topt", "Tpref", "Thermal preference", "ULT50", "Scope of thermal tolerance (CTmax - CTmin)"))

curve_acclim_data <- dat_acclim_ES %>%
  filter(resp_def %in% 
           c("CCO activity", "CS activity", "LDH activity", "log CO2 production", 
             "maximal swimming speed", "Maximum burst swim speed", 
             "Performance breadth (Tbr)", "RMR", "ULT50", "Speed", "Time to heat knockdown",
             "Ucrit", "Umax"))
```

## CT aggregated model 
```{r, echo=FALSE, message=FALSE, results='hide'}
CT_model <-rma.mv(yi, vi, data=CT_acclim_data, mods = ~flux_range * mean_temp_reared +
                        exp_age + size + org_level + exposure_temp, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML")
CT_model
```
## Remaining acclimation metrics model 
```{r, echo=FALSE, message=FALSE, results='hide'}
curve_model <- rma.mv(yi, vi, data=curve_acclim_data, mods = ~flux_range * mean_temp_reared +
                        exp_age + size + org_level + exposure_temp, 
               random = ~1 |  study_id/ experiment_id/ response_id,
                 method="REML")
curve_model
```