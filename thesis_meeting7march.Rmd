---
title: "Thesis meeting"
author: "Maggie Slein"
date: "3/8/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#loading libraries 
pacman::p_load(rvest, rgbif, tidyverse, rnaturalearth, rnaturalearthdata, rgeos)
```


## Pulling down data from GBIF

Notes:

- Excluded genuses from the final meta analysis dataset that did not have greater than 8 sample size (included Platyplectum ornatum (6), Natrix natrix (5), Trachemys scripta (2), Leptopilinia boulardii (6), Clematis vitalba (1))

- Any of the remaining organisms have a sample size of at least 8 when aggregated by genus 

- S. enterica was the only organism with no data on GBIF and was therefor leftout

```{r}
#extracting occurences for each species as available in gbif
c_reevesii <- occ_search(scientificName = "Chinemys reevesii")
a <- c_reevesii$data %>% 
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

x_arvicola <- occ_search(scientificName = "Xylotrechus arvicola")
b <- x_arvicola$data %>% 
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

g_firmus <- occ_search(scientificName = "Gryllus firmus")
c <- g_firmus$data %>% 
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

l_peronii <- occ_search(scientificName = "Limnodynastes	peronii")
d <- l_peronii$data %>% 
  as.data.frame() %>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

l_tasmaniensis <- occ_search(scientificName = "Limnodynastes	tasmaniensis")
e <- l_tasmaniensis$data %>% 
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

d_simulans <- occ_search(scientificName = "Drosophila simulans")
f <- d_simulans$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

r_prolixus <- occ_search(scientificName = "Rhodnius	prolixus")
g <- r_prolixus$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

c_latirostris <- occ_search(scientificName = "Caiman latirostris")
h <- c_latirostris$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

d_melanogaster <- occ_search(scientificName = "Drosophila melanogaster")
i <- d_melanogaster$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

p_chinensis <- occ_search(scientificName = "Plestiodon chinensis")
j <- p_chinensis$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

#no country column 
e_coli <- occ_search(scientificName = "Escherichia 	coli")
k <- e_coli$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()

#zero observations 
s_enetrica <- occ_search(scientificName = "Salmonella	enetrica")$data %>%
  as.data.frame()

d_birchii <- occ_search(scientificName = "Drosophila birchii")
l <- d_birchii$data %>%
  as.data.frame()%>% 
  select(countryCode, genus, species,  decimalLongitude, decimalLatitude) %>%
  drop_na()
#binding all the data together
gbif_data <- bind_rows(a,b,c,d,e,f,g,h,i,j,k,l) %>%
  drop_na()
```

```{r}
#binning data into different temperature zones
regions <- gbif_data %>% 
  mutate(thermal_zone = case_when(between(decimalLatitude, -20, 20.9) ~ "tropical", 
                                  between(decimalLatitude, 21, 40.9) ~ "subtropical",
                                  between(decimalLatitude, -21, -40.9) ~ "subtropical",
                                  between(decimalLatitude, -41, -60.9) ~ "temperate",
                                  between(decimalLatitude, 41, 60.9) ~ "temperate", 
                                  between(decimalLatitude, 61, 90) ~ "arctic", 
                                  between(decimalLatitude, -61, -90) ~ "arctic")) %>%
  mutate(genus = case_when(species == "Caiman latirostris" ~ "Caiman", 
         species %in% c("Drosophila birchii", "Drosophila melanogaster", 
                        "Drosophila simulans") ~ "Drosophila", 
         species == "Escherichia coli " ~ "Escherichia", 
         species == "Gryllus firmus " ~ "Gryllus",
         species %in% c("Limnodynastes peronii", 
                        "Limnodynastes tasmaniensis") ~ "Limnodynastes",
         species == "Mauremys reevesii" ~ "Mauremys",
         species == "Plestiodon chinensis " ~ "Plestiodon",
         species == "Rhodnius prolixus" ~ "Rhodnius",
         species == "Xylotrechus arvicola" ~ "Xylotrechus")) %>%
  drop_na()
```

## Plotting preliminary plot from GBIF data 

- The climate reference bands were pulle from Devinei et al 2015 with the following groups:

Tropical: 20 N - 20 S
Subtropical: 20-40 N, 20-40 S
Extratropical: 40-60 N, 40-60 S

Added in my own category of polar: anything above 60 N or below 60 S

```{r}
#generating data for map overlay
world <- ne_countries(scale = "medium", returnclass = "sf")
#plotting up data 
ggplot(data = world)+
  geom_sf()+
  geom_point(data = regions, aes(x=decimalLongitude, y=decimalLatitude, color=genus), alpha = 0.5)+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = -20, ymax = 20, alpha = 0.2, fill = "lightcoral")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = 20, ymax = 40, alpha = 0.2, fill = "lightgoldenrod")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = -40, ymax = -20, alpha = 0.2, fill = "lightgoldenrod")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = 40, ymax = 60, alpha = 0.2, fill = "yellowgreen")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = -60, ymax = -40, alpha = 0.2, fill = "yellowgreen")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = 60, ymax = 90, alpha = 0.2, fill = "skyblue")+
  annotate("rect",xmin = -Inf, xmax = Inf, ymin = -90, ymax = -60, alpha = 0.2, fill = "skyblue")+
  geom_hline(yintercept = 0, alpha =0.5, linetype= "dashed")+
  theme_classic()+
  theme(legend.position="bottom")+
  ylab("Latitude")+
  xlab("Longitude")
```

```{r}
#writing to csv 
write_csv(regions, "gbif_regiondata.csv")
```


## Running Questions:

- How should thermal regimes be designated? By latitude or country code? Losing some occurence data because country is listed but latitude/longitude are not. 

- How can I successfully join this dataset with the meta analysis dataset to run a model that takes into account location? How should I handle some species that span multiple zones (i.e. Drosophila )

-Should I be grouping by genus or by species? 




        




